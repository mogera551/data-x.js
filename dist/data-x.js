(()=>{var e={108:e=>{function t(e){return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}))}t.keys=()=>[],t.resolve=t,t.id=108,e.exports=t}},t={};function s(r){var i=t[r];if(void 0!==i)return i.exports;var a=t[r]={exports:{}};return e[r](a,a.exports,s),a.exports}s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";class e{static data={};static setData(e){Object.assign(this.data,e)}}class t{static filterByName=new Map;static regist(e,t){this.filterByName.set(e,t)}static forward(e,t){return e.reduce(((e,t)=>"forward"in t.filter?((e,t)=>e.filter.forward(t,e.options))(t,e):e),t)}static backward(e,t){return e.reduce(((e,t)=>"backward"in t.filter?((e,t)=>e.filter.backward(t,e.options))(t,e):e),t)}}class r{static root={};static setRoot(e){this.root=e}}class i{static VALUE=1;static CLASS=2;static RADIO=3;static CHECKBOX=4;static matchClass="class.";static matchRadio="radio";static matchCheckbox="checkbox";static getType(e){return e===this.matchRadio?this.RADIO:e===this.matchCheckbox?this.CHECKBOX:e.startsWith(this.matchClass)?this.CLASS:this.VALUE}static async getValue(e,t){const s=Object.getOwnPropertyDescriptor(e,t);return s?.get?await Reflect.apply(s.get,e,[]):e[t]}static async updateDomByValueType(e){const t=e.domProperty.split("."),s=await this.getValue(e.viewModel,e.path),r=(e,t,s,i=e.shift())=>0===e.length?t[i]!==s&&(t[i]=s):r(e,t[i],s),i=s=>r(t,e.dom,e.filter.forward(e.forwardFilters,s));s instanceof Promise?s.then((e=>i(e))):i(s)}static async updateDomByClassType(e){const t=e.domProperty.slice(this.matchClass.length),s=await this.getValue(e.viewModel,e.path),r=s=>e.filter.forward(e.forwardFilters,s)?!e.dom.classList.contains(t)&&e.dom.classList.add(t):e.dom.classList.contains(t)&&e.dom.classList.remove(t);s instanceof Promise?s.then((e=>r(e))):r(s)}static async updateDomByRadioType(e){const t=await this.getValue(e.viewModel,e.path),s=t=>e.dom.checked=e.dom.value===e.filter.forward(e.forwardFilters,t);t instanceof Promise?t.then((e=>s(e))):s(t)}static async updateDomByCheckboxType(e){const t=await this.getValue(e.viewModel,e.path),s=t=>e.dom.checked=(e.filter.forward(e.forwardFilters,t)??[]).includes(e.dom.value);t instanceof Promise?t.then((e=>s(e))):s(t)}static async setValue(e,t,s){const r=Object.getOwnPropertyDescriptor(e,t);r?.set?await Reflect.apply(r.set,e,[s]):bind.viewModel[t]=s}static async updateViewModelByValueType(e){const t=e.domProperty.split("."),s=(e,t,r=e.shift())=>0===e.length?t[r]:s(e,t[r]),r=e.filter.backward(e.backwardFilters,s(t,e.dom));await this.setValue(e.viewModel,e.path,r)}static async updateViewModelByClassType(e){const t=e.domProperty.slice(this.matchClass.length),s=e.dom.classList.contains(t);await this.setValue(e.viewModel,e.path,s)}static async updateViewModelByRadioType(e){if(e.dom.checked){const t=e.dom.value;await this.setValue(e.viewModel,e.path,t)}}static async updateViewModelByCheckboxType(e){const t=new Set(e.viewModel[e.path]??[]);e.dom.checked?t.add(e.dom.value):t.delete(e.dom.value);const s=Array.from(t);await this.setValue(e.viewModel,e.path,s)}static#e={};static#t={};static init(){this.#e[this.VALUE]=this.updateDomByValueType,this.#e[this.CLASS]=this.updateDomByClassType,this.#e[this.RADIO]=this.updateDomByRadioType,this.#e[this.CHECKBOX]=this.updateDomByCheckboxType,this.#t[this.VALUE]=this.updateViewModelByValueType,this.#t[this.CLASS]=this.updateViewModelByClassType,this.#t[this.RADIO]=this.updateViewModelByRadioType,this.#t[this.CHECKBOX]=this.updateViewModelByCheckboxType}static async updateDom(e,t=e.domPropertyType){await Reflect.apply(this.#e[t],this,[e])}static async updateViewModel(e,t=e.domPropertyType){await Reflect.apply(this.#t[t],this,[e])}}class a{#s;#r;#i;#a;#n;#o;#c;#l;#p;#d;#h;#u;constructor(e,s,r){this.#r=e,this.#i=s.dom?.property,this.#a=r.viewModel,this.#n=s.viewModel?.property,this.#o=s.inputable,this.#h=class{static parse(e){return 0==e.length?[]:e.split("|").map((e=>e.split(":"))).map((([e,s])=>({name:e,options:s?.split(";")??[],filter:t.filterByName.get(e)})))}}.parse(s?.filters.join("|"))??[],this.#u=this.#h.slice().reverse(),this.#s=r,this.#c=r.indexes?.slice()??[],this.#d=i.getType(this.#i);const{path:a,pattern:n}=r.getPathInfo(this.#n);this.#l=a,this.#p=n}get dom(){return this.#r}get domProperty(){return this.#i}get viewModel(){return this.#a}get path(){return this.#l}get pattern(){return this.#p}get domPropertyType(){return this.#d}get forwardFilters(){return this.#h}get backwardFilters(){return this.#u}get filter(){return this.#s.filter}async init(e=this.#o){e&&this.attachEvent(),await this.updateDom()}async updateDom(){await i.updateDom(this)}async updateViewModel(){await i.updateViewModel(this)}attachEvent(e=this.#r,t=this.#s.viewUpdater){e.addEventListener("input",(async e=>await t.updateProcess((()=>this.updateViewModel()))))}}i.init();class n{nodes=[];loops;binds;key}class o{#r;#a;#n;#m=[];#s;#l;#p;#y;constructor(e,t,s){this.#r=e,this.#a=s.viewModel,this.#n=t.viewModel?.property,this.#s=s;const{path:r,pattern:i}=s.getPathInfo(this.#n);this.#l=r,this.#p=i,this.#y=s.loopStack.slice()}get dom(){return this.#r}get viewModel(){return this.#a}get path(){return this.#l}get pattern(){return this.#p}get children(){return this.#m}async createChild(e,t=this.#r,s=this.#s){return s.pushLoop({loop:this,key:e},(()=>{const r=s.loopStack.map((e=>e.key));return s.pushIndexes(r,(async()=>{const r=document.createDocumentFragment(),i=new n;i.key=e;const a=t.content.cloneNode(!0),{binds:o,loops:c}=await s.viewBuilder.build(s,a);return Object.assign(i,{binds:o,loops:c}),r.appendChild(a),i.nodes.push(...Array.from(r.childNodes)),i}))}))}async expand(){console.log("Loop.expand start");const e=await this.viewModel[this.path];for(const t of Object.keys(e))this.#m.push(await this.createChild(t));const t=document.createDocumentFragment(),s=e=>t.appendChild(e);this.#m.forEach((e=>e.nodes.forEach(s))),this.#r.after(t),console.log("Loop.expand complete")}restoreStack(e){const t=this.#y.slice(),s=t=>{if(0===t.length)return e();const r=t.pop();return context.pushLoop(r,s)};return s(t)}removeChild(e){e.loops.forEach((e=>e.contract())),e.nodes.forEach((e=>e.parentNode.removeChild(e)))}contract(e=this.#m){e.forEach((e=>this.removeChild(e))),e.splice(0)}async update(){console.log("Loop.update start"),this.contract(),await this.restoreStack((async()=>this.expand())),console.log("Loop.update end")}}class c{#r;#s;#f;#g;#c;#w;#x;constructor(e,t,s){this.#r=e,this.#f=t,this.#g=t.dom?.event,this.#s=s,this.#c=s.indexes?.slice()??[],this.#w=this.getHandlerName()}get event(){return this.#g}get dom(){return this.#r}get handlerName(){return this.#w}init(){this.attachEvent()}getHandlerName(){const e=this.#r;return`${this.#g.toLowerCase()}${t="x:name"in e?.dataset?e?.dataset["x:name"]:e?.name?.length>0?e.name:e.tagName.toLowerCase(),t?.length>0?t.at(0).toUpperCase()+t.slice(1):""}`;var t}async eventHandler(e,t=this.#s.viewModel,s=this.#s.eventHandler,r=this.handlerName,i=this.#c,a=this.#s){return a.pushIndexes(i,(()=>{console.log("eventHandler start");const a=s.exec(t,r,e,...i);return console.log("eventHandler end"),a}))}attachEvent(e=this.#r,t=this.#g,s=this.#s.viewUpdater){e.addEventListener(t,(e=>s.updateProcess((()=>this.eventHandler(e)))))}}const l=":not([data-x\\:processed])",p="x:ignore",d=["[data-x\\:bind]","[data-x\\:loop]","[data-x\\:events]"].map((e=>`${e}${l}`)).join(","),h=["input","textarea","select","button"].map((e=>`${e}${l}`)).join(",");class u{static async build(e,t,s=e.bindRules){const{loops:r,binds:i,events:n}=class{static inputable(e){return"INPUT"===e.tagName&&"button"!==e.type||"TEXTAREA"===e.tagName||"SELECT"===e.tagName}static testRadio(e){return"INPUT"===e.tagName&&"radio"===e.type}static testCheckbox(e){return"INPUT"===e.tagName&&"checkbox"===e.type}static parsePropertyName(e){const t=e.split("|");return{property:t.shift(),filters:t}}static parseDataBind(e,t,s=this.inputable(e),r=this.testRadio(e),i=this.testCheckbox(e)){const a=(e,t)=>{if(e.includes("=")){const[a,n]=e.split("="),{property:o,filters:c}=this.parsePropertyName(n);t.dom.property=a,t.viewModel.property=o,t.filters=c;const l=s?r?"radio":i?"checkbox":"value":"";t.inputable=l===a}else{const{property:a,filters:n}=this.parsePropertyName(e);t.dom.property=s?r?"radio":i?"checkbox":"value":"textContent",t.viewModel.property=a,t.filters=n,t.inputable=s}return t},n=t.split(",");if(1==n.length)return[a(t,{dom:{},viewModel:{},filters:[]})];{const e=n.map((e=>a(e,{dom:{},viewModel:{},filters:[]})));return e}}static collectByAttribute(e,t,s=[],r=[],i=[]){return Array.from(t.querySelectorAll(d)).forEach((t=>{if(p in t.dataset)return;const n=t.dataset["x:processing"]?.split(",")??[];if("x:loop"in t.dataset){if("TEMPLATE"!==t.tagName)return;if(n.includes("loop"))return;const s={dom:{},viewModel:{property:t.dataset["x:loop"]},filters:[]};r.push(new o(t,s,e)),n.push("loop")}else{if("x:bind"in t.dataset){if(n.includes("bind"))return;s.push(...this.parseDataBind(t,t.dataset["x:bind"]).map((s=>new a(t,s,e)))),n.push("bind")}if("x:events"in t.dataset){if(n.includes("events"))return;t.dataset["x:events"].split(",").forEach((s=>{const r={dom:{event:s},viewModel:{},filters:[]};i.push(new c(t,r,e))})),n.push("events")}}t.dataset["x:processing"]=n.join(",")})),{binds:s,loops:r,events:i}}static collectByImplicit(e,t,s=[],r=[],i=[]){return Array.from(t.querySelectorAll(h)).forEach((t=>{if(p in t.dataset)return;const r=t.dataset["x:processing"]?.split(",")??[],n=this.testRadio(t),o=this.testCheckbox(t),l={dom:{},viewModel:{},filters:[]};if("BUTTON"===t.tagName||"INPUT"===t.tagName&&"button"===t.type){if(r.includes("events"))return;l.dom.event="click",i.push(new c(t,l,e)),r.push("events")}else{if(r.includes("bind"))return;const{property:i,filters:c}=this.parsePropertyName(t.name);l.dom.property=n?"radio":o?"checkbox":"value",l.viewModel.property=i,l.filters=c,l.inputable=!0,s.push(new a(t,l,e)),r.push("bind")}t.dataset["x:processing"]=r.join(",")})),{binds:s,loops:r,events:i}}static collectByRule(e,t,s,r=[],i=[],n=[]){const d=new Map;return s.forEach((e=>{!d.has(e.dom.selector)&&d.set(e.dom.selector,[]),d.get(e.dom.selector).push(e)})),Array.from(d.keys()).forEach((s=>{t.querySelectorAll(`${s}${l}`).forEach((t=>{if(p in t.dataset)return;const l=this.inputable(t),h=t.dataset["x:processing"]?.split(",")??[],u=h.slice();d.get(s).forEach((s=>{const p=JSON.parse(JSON.stringify(s));if("TEMPLATE"===t.tagName){if(h.includes("loop"))return;((t,s)=>{i.push(new o(s,t,e))})(p,t),u.push("loop")}else if("event"in p.dom){if(h.includes("events"))return;((t,s)=>{n.push(new c(s,t,e))})(p,t),u.push("events")}else{if(h.includes("bind"))return;p.inputable=l,((t,s)=>{r.push(new a(s,t,e))})(p,t),u.push("bind")}})),t.dataset["x:processing"]=u.join(",")}))})),{loops:i,binds:r,events:n}}static collect(e,t,s=[]){const r=[],i=[],a=[];return this.collectByRule(e,t,s,r,i,a),this.collectByAttribute(e,t,r,i,a),this.collectByImplicit(e,t,r,i,a),r.forEach((e=>e.dom.dataset["x:processed"]="")),i.forEach((e=>e.dom.dataset["x:processed"]="")),a.forEach((e=>e.dom.dataset["x:processed"]="")),Array.from(t.querySelectorAll("[data-x\\:processing]")).forEach((e=>{e.removeAttribute("data-x:processing")})),{loops:i,binds:r,events:a}}}.collect(e,t,s);return await Promise.all(r.map((e=>e.expand()))),await Promise.all(i.map((e=>e.init()))),n.forEach((e=>e.init())),{loops:r,binds:i,events:n}}}class m{#b;#v;#P;#N;#E;#k;#A;#M;constructor(e,t){this.#P=e,this.#v=t}get name(){return this.#P}get data(){return this.#v}get block(){return this.#b}get root(){return this.#N}createBackLayer(e=this.#P){const t=document.createElement("div");t.dataset["x:dialog"]=e;const s=document.createElement("div");s.style.position="fixed",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="space-around",s.style.backgroundColor="rgba(0, 0, 0, 0.5)",s.style.left="0",s.style.top="0",s.style.height="100vh",s.style.width="100vw",s.style.zIndex="499",s.classList.add("bg"),s.addEventListener("click",(e=>this.cancelDialog())),t.appendChild(s);const r=document.createElement("div");return r.style.backgroundColor="white",r.style.borderRadius=".375rem",r.style.padding="2rem",r.classList.add("fg"),r.addEventListener("click",(e=>e.stopPropagation())),s.appendChild(r),{root:t,bg:s,fg:r}}async create(e=this.#P,t=this.#v,s=!1){const{root:r,bg:i,fg:a}=this.createBackLayer(e),n=await j.build(e,a,s,t,this);document.body.appendChild(r),this.#b=n,this.#N=r}cancelDialog(){this.#M&&this.#M()}closeDialog(e){this.#A&&this.#A(e)}async main(){return new Promise(((e,t)=>{this.#A=e,this.#M=t})).finally((()=>{this.#N.parentNode.removeChild(this.#N)}))}static async open(e,t={}){const s=new m(e,t);return s.create(),s.main()}}class y{name;pattern;indexes;lastName;parentName;constructor({name:e=null,pattern:t=null,indexes:s=null}){this.name=e,this.pattern=t,this.indexes=s,null==e&&null!=t&&null!=s&&(this.name=y.expand(t,s));const r=this.name.split(".");this.lastName=r.pop(),this.parentName=r.join(".")}static expand(e,t,s=t.slice()){let r=!1;const i=e.replaceAll("*",(()=>s.shift()??(r=!0,"*")));return r?null:i}static createByName(e){return new y({name:e})}static createByPatternIndexes(e,t){return new y({pattern:e,indexes:t})}}class f{static async exec(e,t,...s){const r=t[0].toUpperCase()+t.slice(1),i=`event${r}`,a=`on${r}`;if(i in e){const t=Object.getOwnPropertyDescriptor(e,i);return Reflect.apply(t.set,e,[s])}if(a in e)return e[a](...s)}}class g{static async init(e,t,s=e.viewModel,r=e.properties){const i=[];for(const e of r.values){const r=t=>e.name.includes(".")?s[e.name]=t:s[`__${e.name}`]=t;e?.init&&("AsyncFunction"===e.init.constructor.name?i.push(e.init(t).then((e=>r(e)))):r(e.init(t)))}return await Promise.all(i),f.exec(s,"init",t)}}class w{static reflect(e,t,s={}){Object.keys(t).forEach((r=>{const i=`$${r}`,a=t=>!1!==t&&e.$postProcess((()=>{e.$notify(i),e.$notifyAll(i)})),n={configurable:!1,enumerable:!0,get:()=>Reflect.get(t,r),set:e=>{const s=Reflect.set(t,r,e);return s instanceof Promise?s.then(a):a(s),s}};Object.defineProperty(s,i,n)}))}}class x{#s;constructor(e){this.#s=e}async build(e=this.#s,t=this.#s.viewBuilder,s=this.#s.rootElement){const r=await t.build(e,s);e.setBindTree(r),e.buildBinds()}appear(e=this.#s){const t=e.parentElement.attachShadow({mode:"open"});t.appendChild(e.rootElement),e.rootElement=t}}class b{#s;#B=[];constructor(e){this.#s=e}registPostProcess(e){this.#B.push(e)}async postProcess(){const e=this.#B.slice(),t=[];return e.length>0&&this.updateProcess((()=>{for(const s of e)t.push(s())})),Promise.all(t)}clearPostProcess(){this.#B.splice(0)}async updateDom(e=this.#s.notifier,t=this.#s.allBinds,s=this.#s.allLoops,r=this.#s.dependencies){console.log("start updateDom");const i=[];e.queue.forEach((({name:e,indexes:t})=>i.push(...r.getReferedProperties(e,t),(({name:e,indexes:t})=>({name:y.expand(e,t),pattern:e,indexes:t}))({name:e,indexes:t}))));const a=new Set(i.map((e=>e.name)));console.log("setOfUpdatePaths = ",a),await Promise.all(s.filter((e=>a.has(e.path))).map((e=>e.update()))),console.log("loop end"),await Promise.all(t.filter((e=>a.has(e.path))).map((e=>e.updateDom()))),console.log("bind end"),console.log("complete updateDom")}async updateProcess(e,t=this.#s,s=this.#s.notifier,r=this.#s.properties){this.clearPostProcess(),s.clear(),r.clearStatus();const i=await e();console.log("updateCallback() = ",i),await i,await this.updateDom(),r.isUpdate&&t.buildBinds(),await this.postProcess()}}class v{parentNodes=[];name;func;childNodes=[];constructor(e){this.name=e}}class P{#R=new Map;#D;#s;constructor(e){this.#s=e}get map(){return this.#R}build(e=this.#R,t=this.#s.dependencyRules){e.clear(),this.#D=this.#s.dependencyRules.slice(),t.forEach((([e,t,s])=>this.add(e,t,s))),this.implicitDependency()}implicitDependency(e=this.#s.properties){for(const t of e.names)e.getDependencyNames(t).forEach((e=>this.add(e,[t])))}add(e,t,s,r=this.#R){r.has(e)||r.set(e,new v(e));const i=r.get(e);i.func=s,t.forEach((e=>{r.has(e)||r.set(e,new v(e));const t=r.get(e);i.childNodes.push(t),t.parentNodes.push(i)}))}getReferedProperties(e,t,s=this.#R){const r=s.get(e),i=t??[],a=(e,t)=>{if(null==e)return t;const s=y.expand(e.name,i);return null!==s&&t.push({name:s,pattern:e.name,indexes:e.func?e.func(i):i}),e.parentNodes.forEach((e=>{t=a(e,t)})),t},n=a(r,[]),o=[];return n.forEach((e=>{const t=new Set(o.map((e=>e.name)));t.has(e)||o.push(e)})),o}}class N{static PLAIN=1;static PATTERN=2;static EXPANDED=3}class E{#P;#p;#$;#T;#s;#C;#O;#S;#L=!0;#j=!1;#I;constructor(e,t,s,r,i,a){this.#s=e,this.#S=t,this.#P=s,this.#p=r,this.#C=i,this.#O=a;const n=s.split(".");this.#$=n.pop(),this.#T=n.join(".")}get context(){return this.#s}get name(){return this.#P}get pathParent(){return this.#T}get pathLastElement(){return this.#$}get desc(){return this.#C}get init(){return this.#O}get type(){return this.#S}get pattern(){return this.#p}get isArray(){return this.testIsArray()}get referedPatternProperties(){return this.getReferedPatternPeoperties()}get value(){return this.getValue()}get isNew(){return this.#L}get isUpdate(){return this.#j}get hasSetter(){return null!=this.desc.set}set desc(e){this.#C=e,Object.defineProperty(this.#s.viewModel,this.#P,e)}set isNew(e){this.#L=e}set isUpdate(e){this.#j=e}testIsArray(){return!1}getReferedPatternPeoperties(){return[]}getValue(){throw new Error("")}clearStatus(){this.isNew=!1,this.isUpdate=!1}static create(e,{name:t=null,desc:s={},patternProperty:r=null,patternIndexes:i=[],requireSetter:a=null,init:n=null}){return null!=r?new M(e,r,i):(null===a&&(a="set"in s),t.includes("*")?new A(e,t,s,a,n):new k(e,t,s,a,n))}}class k extends E{constructor(e,t,s,r,i){super(e,N.PLAIN,t,t,s,i),this.#V(r)}testIsArray(e=this.name,t=this.context.properties){return t.testIsArray(e)}#V(e){this.context.viewModel;const t=this.context.notifier,s=this.context.cache,r=this.pathParent,i=this.pathLastElement,a=this.name.includes("."),n=`__${this.name}`,o=this.name,c=this.desc,l=a?function(e){const a=c.set?Reflect.apply(c.set,this,[e]):this[r][i]=e;return this.isUpdate=!0,s.delete(o),(async()=>{!1!==await a&&await t.notify(o)})()}:function(e){const r=c.set?Reflect.apply(c.set,this,[e]):this[n]=e;return this.isUpdate=!0,s.delete(o),(async()=>{!1!==await r&&await t.notify(o)})()},p={configurable:!0,enumerable:!0,get:a?function(){return s.has(o)?s.get(o):s.set(o,c.get?Reflect.apply(c.get,this,[]):this[r]?.[i])}:function(){return s.has(o)?s.get(o):s.set(o,c.get?Reflect.apply(c.get,this,[]):this[n])}};e&&(p.set=l),this.desc=p}getReferedPatternPeoperties(e=this.context.properties,t=this.name){return e.getReferedPatternPeoperties(t)}getValue(){return Reflect.apply(this.desc.get,this.context.viewModel,[this.name])}}class A extends E{constructor(e,t,s,r,i){super(e,N.PATTERN,t,t,s),this.#V(r)}testIsArray(e=this.pattern,t=this.context.properties){return t.testIsArray(e)}#V(e){const t=this.context,s=(this.context.viewModel,this.pathParent),r=this.pathLastElement,i=this.pattern.split("").filter((e=>"*"===e)).length,a=this.desc,n={configurable:!0,enumerable:!0,get:a.get?a.get:function(){const e="*"===r?(t?.indexes??[]).at(i-1):r;return this[s]?.[e]}};e&&(n.set=a.set?a.set:function(e){const a="*"===r?(t?.indexes??[]).at(i-1):r;this[s][a]=e,this.isUpdate=!0}),this.desc=n}getReferedPatternPeoperties(e=this.context.properties,t=this.pattern){return e.getReferedPatternPeoperties(t)}}class M extends E{#U;#q;constructor(e,t,s){const r=y.expand(t.pattern,s);super(e,N.EXPANDED,r,t.pattern,null,t.init),this.#U=t,this.#q=s.slice(),this.#V()}get patternProperty(){return this.#U}get patternIndexes(){return this.#q}#V(){const e=this.context,t=this.context.cache,s=this.context.viewModel,r=this.context.notifier,i=(this.context.properties,this.patternProperty),a=this.patternIndexes,n=this.name,o={configurable:!0,enumerable:!0,get:()=>e.pushIndexes(a,(()=>t.has(n)?t.get(n):t.set(n,s[i.pattern])))};null!=i.desc.set&&(o.set=o=>e.pushIndexes(a,(()=>{const e=Reflect.apply(i.desc.set,s,[o]);return this.isUpdate=!0,t.delete(n),(async()=>{!1!==await e&&await r.notify(i.pattern,a)})()}))),this.desc=o}testIsArray(e=this.patternProperty.pattern,t=this.context.properties){return t.testIsArray(e)}getReferedPatternPeoperties(e=this.patternProperty){return e.referedPatternProperties}getValue(){return Reflect.apply(this.desc.get,this.context.viewModel,[this.name])}}class B{#s;#F=new Map;#j=!1;constructor(e){this.#s=e}get names(){return Array.from(this.#F.keys())}get values(){return Array.from(this.#F.values())}build(e=this.#s,t=this.#s.viewModel){this.#F.clear();const s=Object.getPrototypeOf(t),r=e=>({configurable:!0,enumerable:!1,writable:!0,value:e?.value}),i=e=>/^\@\@?([a-zA-Z0-9_\.\*])+(#(get|set|init))?$/.test(e),a=e=>/^#(event[a-zA-Z0-9_]+)$/.test(e),n=e=>/^__([a-zA-Z0-9_])+$/.test(e),o=new Map;[t].forEach((e=>{Object.entries(Object.getOwnPropertyDescriptors(e)).forEach((([e,s])=>{if(i(e)||n(e)||a(e))if(n(e))Reflect.defineProperty(t,e,r(s));else if(i(e)){const[r,i]=e.includes("#")?e.split("#"):[e,null],a="@"===e.at(1),n=a?r.slice(2):r.slice(1),c=o.has(n)?o.get(n):{baseName:null,originalName:null,privateName:null,get:null,set:null,init:null,requireGet:!1,requireSet:!1,privateValue:void 0};c.baseName=c.baseName??n,c.originalName=c.originalName??r,c.privateName=c.privateName??`__${n}`,c.get="get"===i?s.value:c.get,c.set="set"===i?s.value:c.set,c.init="init"===i?s.value:c.init,c.requireGet=null==i||c.requireGet,c.requireSet=a,c.privateValue=null==i?s.value:c.privateValue,o.set(n,c),Reflect.deleteProperty(t,e)}else if(a(e)){const r=e,i="set",a=!0,n=r.slice(1),c=o.has(n)?o.get(n):{baseName:null,originalName:null,privateName:null,get:null,set:null,init:null,requireGet:!1,requireSet:!1,privateValue:void 0};c.baseName=c.baseName??n,c.originalName=c.originalName??r,c.privateName=c.privateName??`__${n}`,c.set="set"===i?s.value:c.set,c.requireGet=null==i||c.requireGet,c.requireSet=a,c.privateValue=null==i?s.value:c.privateValue,o.set(n,c),Reflect.deleteProperty(t,e)}}))})),Array.from(o.entries()).forEach((([i,a])=>{a.privateName in t||a.baseName.includes(".")||Reflect.defineProperty(t,a.privateName,r({value:a.privateValue}));const n=Object.getOwnPropertyDescriptor(t,i)??Object.getOwnPropertyDescriptor(s,i)??{};n.get=null!=a.get?a.get:n.get??null,n.set=null!=a.set?a.set:n.set??null;const o=a.init,c=a.requireSet,l=i;this.setProperty(E.create(e,{name:l,desc:n,requireSetter:c,init:o}))})),[t,s].forEach((t=>{Object.entries(Object.getOwnPropertyDescriptors(t)).forEach((([t,s])=>{this.#F.has(t)||(null!=s?.get?this.setProperty(E.create(e,{name:t,desc:s,requireSetter:null!=s?.set})):null!=s?.set&&this.setProperty(E.create(e,{name:t,desc:s,requireSetter:!0})))}))}));const c=[];for(const e of this.#F.keys()){const t=[],s=e.split("."),r=[];s.forEach((e=>{r.push(e),t.push(r.join("."))})),c.push(...t)}Array.from(new Set(c)).filter((e=>!this.#F.has(e))).forEach((r=>{const i=Object.getOwnPropertyDescriptor(t,r)??Object.getOwnPropertyDescriptor(s,r)??{};this.setProperty(E.create(e,{name:r,desc:i,requireSetter:!0}))})),Object.defineProperty(t,"$context",{get:()=>e})}removeProperty(e,t=this.#s.viewModel,s=this.#s.cache,r=this.#F){delete t[e],r.delete(e),s.delete(e)}getProperty(e,t=this.#F){return t.get(e)}setProperty(e,t=this.#F){t.set(e.name,e)}async#H(e){console.log("#expand start",e.name);const t=e.type===N.EXPANDED?e.patternIndexes:[];console.log(t);const s=await e.value;console.log(s);const r=Object.keys(s)??[];console.log(r);const i=this.#s;for(const s of e.referedPatternProperties){const e=s.pattern;for(const a of r){const r=t.concat(a);if(!y.expand(e,r).includes("*")){const e=E.create(i,{patternProperty:s,patternIndexes:r,requireSetter:s.hasSetter});this.setProperty(e),s.isArray&&await this.#H(e)}}}console.log("#expand end",e.name)}async expand(e,t=null){const s=this.getProperty(e);null!=s&&await this.#H(s)}#_(e){const t=(e.type===N.EXPANDED?e.patternIndexes:[]).join("\t"),s=e=>e.patternIndexes.join("\t").startsWith(t);e.referedPatternProperties.forEach((e=>{this.getExpandedPropertiesByPatternProperty(e).filter(s).forEach((e=>{this.removeProperty(e.name)}))}))}contract(e){const t=this.getProperty(e);null!=t&&this.#_(t)}testIsArray(e,t=this.#F){return t.has(`${e}.*`)}async#X(e,t=this.#s.cache){console.log("#update start",e),t.delete(e);const s=this.getProperty(e);null!=s&&s.isArray&&(this.#_(s),await this.#H(s)),console.log("#update complete",e)}async updateByName(e,t=this.#s.cache){console.log("updateByName start",e),await this.#X(e);for(const t of this.#s.dependencies.getReferedProperties(e))console.log("updateInfo = ",t),e!==t.name&&await this.#X(t.name);console.log("updateByName complete",e)}async updateByPatternIndexes({name:e,indexes:t}){console.log("updateByPatternIndexes start",e,t);const s=y.expand(e,t);await this.updateByName(s)}async expandAll(e=this.#F){await Promise.all(Array.from(e.entries()).map((async([e,t])=>{!e.includes("*")&&t.isArray&&this.#H(t)})))}has(e,t=this.#F){return t.has(e)}getReferedPatternPeoperties(e){const t=`${e}.`;return this.names.filter((e=>e.startsWith(t))).map((e=>this.getProperty(e))).filter((e=>e.type===N.PATTERN))}getDependencyNames(e){const t=`${e}.`;return this.names.filter((e=>e.startsWith(t)&&!e.slice(t.length).includes("."))).map((e=>this.getProperty(e))).filter((e=>e.type===N.PATTERN||N.PLAIN)).map((e=>e.name))}getExpandedPropertiesByPatternProperty(e){return this.values.filter((e=>e.type===N.EXPANDED)).filter((t=>t.patternProperty===e))}clearStatus(){return this.values.forEach((e=>e.clearStatus()))}get isUpdate(){return this.values.some((e=>e.isUpdate||e.isNew))}}class R{#z=[];#s;constructor(e){this.#s=e}get queue(){return this.#z}async notify(e,t=[]){this.#z.push({name:e,indexes:t}),await this.#s.properties.updateByPatternIndexes({name:e,indexes:t})}clear(){this.#z.splice(0)}}class D{#W=new Map;#s;constructor(e){this.#s=e}has(e){return this.#W.has(e)}get(e){const t=this.#W.get(e);return console.log("cache.get = ",e,t),t}set(e,t){return t instanceof Promise?(this.#W.set(e,t),t.then((t=>this.#W.set(e,t)))):this.#W.set(e,t),t}delete(e){this.#W.delete(e)}}class ${#G;#K;#Q;#a;#Z;#J;#Y;#ee={binds:[],loops:[]};#te=[];#se=[];#y=[];#re=[];#ie;#ae;#W;#ne;#oe;#b;#ce;#le;#v;#pe;#de;constructor(e,t){this.#b=e,this.#G=t}build(){this.#Q=new x(this),this.#Z=u,this.#J=new b(this),this.#Y=new P(this),this.#ie=new B(this),this.#ae=new R(this),this.#W=new D(this),this.#ne=t,this.#oe=r.root,this.#ce=f,this.#le=g,this.#v=e.data,this.#pe=w}get parentElement(){return this.#G}get rootElement(){return this.#K}get view(){return this.#Q}get viewModel(){return this.#a}get viewBuilder(){return this.#Z}get viewUpdater(){return this.#J}get dependencies(){return this.#Y}get bindTree(){return this.#ee}get allBinds(){return this.#te}get allLoops(){return this.#se}get indexesStack(){return this.#re}get indexes(){return this.#re[this.#re.length-1]}get $1(){return this.indexes[0]}get $2(){return this.indexes[1]}get $3(){return this.indexes[2]}get $4(){return this.indexes[3]}get $5(){return this.indexes[4]}get $6(){return this.indexes[5]}get $7(){return this.indexes[6]}get $8(){return this.indexes[7]}get loopStack(){return this.#y}get currentLoop(){return this.#y[this.#y.length-1]}get properties(){return this.#ie}get notifier(){return this.#ae}get cache(){return this.#W}get context(){return this}get filter(){return this.#ne}get rootBlock(){return this.#oe}get block(){return this.#b}get eventHandler(){return this.#ce}get initializer(){return this.#le}get data(){return this.#v}get dataReflecter(){return this.#pe}get template(){return this.#de.template}get module(){return this.#de}get bindRules(){return this.#de.bindRules}get dependencyRules(){return this.#de.dependencyRules}set module(e){this.#de=e,this.#a=void 0!==e.viewModel?e.viewModel:void 0!==e.AppViewModel?Reflect.construct(e.AppViewModel,[]):{},this.#K=e.template.content.cloneNode(!0);const t=e?.context??e?._;null!=t&&this.reflect(t,e.dialog)}set rootElement(e){this.#K=e}pushIndexes(e,t){this.#re.push(e);try{return t()}finally{this.#re.pop()}}pushLoop({loop:e,key:t},s){this.#y.push({loop:e,key:t});try{return s()}finally{this.#y.pop()}}getPathInfo(e,t=e,s=this.currentLoop?.loop,r=this.currentLoop?.key,i=this.indexes??[]){return"."===e[0]?"."===e?{path:`${s.path}.${r}`,pattern:`${s.pattern}.*`}:{path:`${s.path}.${r}.${e}`,pattern:`${s.pattern}.*.${e}`}:{path:y.expand(t,i),pattern:t}}setBindTree({binds:e,loops:t},s=this.bindTree){s.binds.splice(0),s.loops.splice(0),s.binds.push(...e),s.loops.push(...t)}buildBinds(e=this.bindTree,t=this.allBinds,s=this.allLoops){t.splice(0),s.splice(0);const r=e=>t.push(e),i=e=>s.push(e);e.binds.forEach(r),e.loops.forEach(i);const a=e=>{e.children.forEach((e=>{e.binds.forEach(r),e.loops.forEach(i),e.loops.forEach(a)}))};e.loops.forEach(a)}reflect(e,t){const s=Object.getPrototypeOf(this);if(Object.entries(Object.getOwnPropertyDescriptors(s)).forEach((([t,s])=>{if(null!=s?.get){const r={configurable:!0,enumerable:!0,get:(...e)=>Reflect.apply(s.get,this,e)};Object.defineProperty(e,t,r)}})),[["$notify","notify"],["$notifyAll","notifyAll"],["$inquiryAll","inquiryAll"],["$openDialog","openDialog"],["$postProcess","postProcess"]].forEach((([t,s])=>{const r={configurable:!0,enumerable:!1,value:"AsyncFunction"===t.constructor.name?async(...e)=>Reflect.apply(this[t],this,e):(...e)=>Reflect.apply(this[t],this,e)};Object.defineProperty(e,s,r)})),null!=t){this.$closeDialog=function(e){t.closeDialog(e)};const s={configurable:!0,enumerable:!1,value:(...e)=>Reflect.apply(this.$closeDialog,this,e)};Object.defineProperty(e,"closeDialog",s),this.$cancelDialog=function(){t.cancelDialog()};const r={configurable:!0,enumerable:!1,value:(...e)=>Reflect.apply(this.$cancelDialog,this,e)};Object.defineProperty(e,"cancelDialog",r)}}$notify(e,t=[]){this.notifier.notify(e,t)}$postProcess(e){this.viewUpdater.registPostProcess(e)}async $notifyAll(e,t=[]){this.rootBlock.notifyAll(e,t,this.block)}async $inquiryAll(e,t,s){this.$postProcess((()=>this.rootBlock.inquiryAll(e,t,s,this.block)))}async $openDialog(e,t={}){return m.open(e,t)}}const T="--bind-",C="--bind-class-";class O{dom={selector:""};viewModel={};filters=[];static createBind(e,t,s,r){const i=new O;return i.dom.selector=e,i.dom.property=t,i.viewModel.property=s,i.filters.push(...r),i}static createEvent(e,t){const s=new O;return s.dom.selector=e,s.dom.event=t,s}static createLoop(e,t){const s=new O;return s.dom.selector=e,s.viewModel.property=t,s}static build(e){const t=[];for(let s=0;s<e.style.length;s++){const r=e.style[s],i=e.style.getPropertyValue(r).trim();if("--events"===r)for(const s of i.split(",")){const r=O.createEvent(e.selectorText,s);t.push(r)}else if("--loop"===r){const s=O.createLoop(e.selectorText,i);t.push(s)}else if(r.startsWith(C)){const s=i.split("|"),a=s.shift(),n=s,o=O.createBind(e.selectorText,"class."+r.slice(C.length),a,n);t.push(o)}else if(r.startsWith(T)){const s=i.split("|"),a=s.shift(),n=s,o=O.createBind(e.selectorText,r.slice(T.length).replaceAll("-","."),a,n);t.push(o)}}return t}}class S{static spaPath;static filterPath;static localFilter;static setOptions(e,t){this.spaPath=t.spaPath??`${e}-spa`,this.localFilter=t.localFilter??!1,this.filterPath=this.localFilter?t.filterPath??`${this.spaPath}/module/filter`:null}}class L{viewModel;AppViewModel;html;css;bindCss;dependencyRules;template;bindRules;context;_;dialog;static async load(e,t,s=S.spaPath,r=new L){const i=await this.loadScript(e,s);if(Object.assign(r,i?.default??{}),void 0===r.html){const t=await this.loadHtml(e,s);Object.assign(r,{html:t})}if(void 0===r.css){const t=await this.loadCss(e,s);Object.assign(r,{css:t})}if(t&&void 0===r.bindCss&&void 0===r.bindRules){const t=await this.loadBindCss(e,s);Object.assign(r,{bindCss:t})}const a=this.buildTemplate(e,r.html,r.css);if(Object.assign(r,{template:a}),void 0===r.bindRules&&void 0!==r.bindCss){const e=this.buildBindRules(r.bindCss);Object.assign(r,{bindRules:e})}return void 0===r.dependencyRules&&(r.dependencyRules=[]),void 0===r.bindRules&&(r.bindRules=[]),r}static async loadScript(e,t=S.spaPath){const s=t.startsWith("https://")||t.startsWith("http://"),r=document.baseURI.lastIndexOf("/"),i=r>=0?document.baseURI.slice(0,r+1):"";return import(s?`${t}/module/${e}.js`:`${i}${t}/module/${e}.js`).catch((e=>{throw console.error(e),e}))}static async loadHtml(e,t=S.spaPath){return fetch(`${t}/html/${e}.html`).then((e=>{if(!e.ok)throw console.error("response.ok:",e.ok),console.error("esponse.status:",e.status),console.error("esponse.statusText:",e.statusText),new Error(e.statusText);return e.text()})).catch((e=>{throw console.error(e),e}))}static async loadCss(e,t=S.spaPath){return fetch(`${t}/css/${e}.css`).then((e=>{if(!e.ok)throw console.error("response.ok:",e.ok),console.error("esponse.status:",e.status),console.error("esponse.statusText:",e.statusText),new Error(e.statusText);return e.text()})).catch((e=>{throw console.error(e),e}))}static async loadBindCss(e,t=S.spaPath){return fetch(`${t}/css/${e}.bind.css`).then((e=>{if(!e.ok)throw console.error("response.ok:",e.ok),console.error("esponse.status:",e.status),console.error("esponse.statusText:",e.statusText),new Error(res.statusText);return e.text()})).catch((e=>{throw console.error(e),e}))}static buildTemplate(e,t,s){const r=document.createElement("template");return r.innerHTML=t,void 0!==s&&(r.innerHTML="<style>\n"+s+"\n</style>\n"+r.innerHTML),r.dataset["x:block"]=e,r}static buildBindRules(e){return class{static collect(e){const t=document.createElement("div");document.body.appendChild(t);const s=t.attachShadow({mode:"open"}),r=document.createElement("style");r.textContent=e;const i=[];s.appendChild(r);const a=Array.from(s.styleSheets).find((e=>e.ownerNode===r));return Array.from(a?.cssRules??[]).map((e=>i.push(...O.build(e)))),document.body.removeChild(t),i}}.collect(e)}}class j{#P;#s;#he=[];#ue;constructor(e=null){this.#ue=e}get context(){return this.#s}get name(){return this.#P}createContext(e,t){return this.#P=e,this.#s=new $(this,t),this.#s.build(),this.#s}async load(e,t,s){const r=this.createContext(e,t);try{const t=await L.load(e,s);t.dialog=this.#ue,r.module=t}catch(e){throw e}}async buildView(t=e.data,s=this.#s){s.properties.build(),s.dependencies.build(),s.dataReflecter.reflect(s,t,s.viewModel),await s.initializer.init(s,t),await s.properties.expandAll(),await s.view.build(),this.#he.push(...await I.build(s.rootElement)),s.view.appear(),await s.viewUpdater.postProcess()}static async build(t,s,r,i=e.data,a=null){const n=new j(a);return await n.load(t,s,r),await n.buildView(i),n}async notifyAll(e,t,s){const r=this.#s.notifier,i=this.#s.viewModel,a=this.#s.eventHandler,n=this.#s.viewUpdater;for(const r of this.#he)r.notifyAll(e,t,s);s!==this&&n.updateProcess((async()=>{const n=a.exec(i,"notifyAll",e,t,s),o=()=>r.notify(e);return n instanceof Promise?n.then((()=>o())):o(),n}))}async inquiryAll(e,t,s,r){const i=this.#s.viewModel,a=this.#s.eventHandler,n=this.#s.viewUpdater;for(const i of this.#he)i.inquiryAll(e,t,s,r);r!==this&&n.updateProcess((async()=>a.exec(i,"inquiryAll",e,t,s,r)))}}class I{static async build(e){return await Promise.all((e=>Array.from(e.querySelectorAll("[data-x\\:block]")))(e).map((e=>(async e=>{const t=e.dataset["x:block"],s="x:withBindCss"in e.dataset;return j.build(t,e,s)})(e))))}}class V{#he=[];async build(){this.#he.push(...await I.build(document.body))}async notifyAll(e,t,s){for(const r of this.#he)r.notifyAll(e,t,s)}async inquiryAll(e,t,s,r){for(const i of this.#he)i.inquiryAll(e,t,s,r)}}t.regist("falsey",{forward:(e,t=[])=>!e}),t.regist("not",{forward:(e,t=[])=>!e}),t.regist("null",{forward:(e,t=[])=>null==e}),t.regist("style-display",{forward:(e,t=[])=>e?"":"none"}),t.regist("locale-string",{forward:(e,t=[])=>Number(e).toLocaleString()}),t.regist("fixed",{forward:(e,t=[])=>Number(e).toFixed(t[0]??0)}),t.regist("ge",{forward:(e,t=[])=>Number(e)>=Number(t[0]??0)}),t.regist("gt",{forward:(e,t=[])=>Number(e)>Number(t[0]??0)}),t.regist("le",{forward:(e,t=[])=>Number(e)<=Number(t[0]??0)}),t.regist("lt",{forward:(e,t=[])=>Number(e)<Number(t[0]??0)}),t.regist("number-value",{forward:(e,t=[])=>e?.toString()??"",backward:(e,t=[])=>""!==e?Number(e):null});window.datax=class{static root;static async boot(t={},i={}){e.setData(t),S.setOptions(this.getBaseName(),i),await class{static async registLocalFilter(e=S.localFilter,t=S.filterPath){if(e){const e=document.baseURI.lastIndexOf("/"),r=e>=0?document.baseURI.slice(0,e+1):"";await s(108)(`${r}${t}/regist.js`)}}}.registLocalFilter(),this.root=new V(this),r.setRoot(this.root),await this.root.build()}static getBaseName(){const e=location.href.split("/").pop();if(e){const t=e.split(".");return t.pop(),t.join(".")}return e}}})()})();